// ==UserScript==
// @name         offlineNotice
// @author       某人
// @version      1.0.0
// @description  掉线通知，仅分离部署
// @timestamp    0
// @license      MIT
// @homepageURL  https://github.com/lyjjl
// ==/UserScript==

(()=>{var c="offlineNotice",O="state";function _(o,t){let e=o.storageGet(t);if(!e)return null;try{return JSON.parse(e)}catch(n){return console.error(`[${c}] storage parse failed:`,n),null}}function m(o,t,e){try{o.storageSet(t,JSON.stringify(e))}catch(n){console.error(`[${c}] storage set failed:`,n)}}function v(o,t){let e=(o||"").trim(),n=(t||"").trim();if(!n)return e;let i=e.includes("?")?"&":"?";return`${e}${i}access_token=${encodeURIComponent(n)}`}function S(o){let t=(o||"").trim();if(!t)return null;let e=/^user_id\s*=\s*(\d+)\s*$/i.exec(t);if(e)return{kind:"private",userId:e[1]};let n=/^group_id\s*=\s*(\d+)\s*$/i.exec(t);if(n)return{kind:"group",groupId:n[1]};let s=/^(\d+)\s*$/.exec(t);return s?{kind:"private",userId:s[1]}:null}function x(o,t){let e=(o||"").trim().replace(/\/+$/,""),n=(t||"").trim().replace(/^\/+/,"");return`${e}/${n}`}function E(o){var r,l;let t=typeof o.time=="number"?o.time:0,e=t>0?new Date(t*1e3).toISOString():new Date().toISOString(),n=((r=o.status)==null?void 0:r.online)===!0?"true":"false",s=((l=o.status)==null?void 0:l.good)===!0?"true":"false",i=typeof o.interval=="number"?o.interval:-1;return["[SealDice] OneBot Heartbeat Offline",`time=${e}`,`self_id=${String(o.self_id)}`,`status.online=${n}`,`status.good=${s}`,`interval_ms=${i}`].join(`
`)}var d=class{constructor(t){this.ws=null;this.notifyChain=Promise.resolve();this.reconnectTimer=null;this.ext=t,this.state=_(t,O)||{}}start(){this.clearReconnectTimer(),this.connectWs()}stop(){if(this.clearReconnectTimer(),this.ws){try{this.ws.close()}catch(t){console.error(`[${c}] ws close failed:`,t)}this.ws=null}}debugLog(...t){seal.ext.getBoolConfig(this.ext,"DEBUG_LOG")&&console.log(`[${c}]`,...t)}clearReconnectTimer(){if(this.reconnectTimer){try{clearTimeout(this.reconnectTimer)}catch(t){}this.reconnectTimer=null}}scheduleReconnect(){this.clearReconnectTimer();let t=seal.ext.getIntConfig(this.ext,"ONEBOT_WS_RECONNECT_SEC"),e=Math.max(1,t)*1e3;this.debugLog(`schedule reconnect in ${e}ms`),this.reconnectTimer=setTimeout(()=>{this.connectWs()},e)}saveState(){m(this.ext,O,this.state)}connectWs(){let t=seal.ext.getStringConfig(this.ext,"ONEBOT_WS_SERVER"),e=seal.ext.getStringConfig(this.ext,"ONEBOT_WS_TOKEN"),n=v(t,e);if(!n){console.error(`[${c}] ONEBOT_WS_SERVER is empty, skip connect`),this.scheduleReconnect();return}this.debugLog(`connecting ws: ${n}`);try{let s=new WebSocket(n);this.ws=s,s.addEventListener("open",()=>{this.debugLog("ws opened")}),s.addEventListener("message",i=>{let r=i.data,l=typeof r=="string"?r:r&&typeof r.toString=="function"?r.toString():"";l&&(this.notifyChain=this.notifyChain.then(()=>this.onWsText(l)).catch(u=>{console.error(`[${c}] message handler failed:`,u)}))}),s.addEventListener("error",i=>{console.error(`[${c}] ws error:`,i)}),s.addEventListener("close",()=>{this.debugLog("ws closed"),this.ws=null,this.scheduleReconnect()})}catch(s){console.error(`[${c}] ws connect failed:`,s),this.ws=null,this.scheduleReconnect()}}async onWsText(t){var r;let e;try{e=JSON.parse(t)}catch(l){return}if(!e||e.post_type!=="meta_event"||e.meta_event_type!=="heartbeat")return;let n=e;this.state.lastHeartbeatAtMs=Date.now(),this.saveState();let s=((r=n.status)==null?void 0:r.online)===!0,i=this.state.lastOnline;this.state.lastOnline=s,this.saveState(),s?this.debugLog("heartbeat online"):await this.handleOffline(n,i)}async handleOffline(t,e){let n=Date.now(),s=seal.ext.getIntConfig(this.ext,"ALERT_COOLDOWN_SEC"),i=Math.max(0,s)*1e3,r=this.state.lastNotifiedAtMs||0;if(i>0&&n-r<i){this.debugLog("offline but in cooldown, skip notify");return}let u=E(t);this.state.lastNotifiedAtMs=n,this.saveState(),await this.sendNotifications(u),e===!0||e===void 0?this.debugLog("offline alert sent (state changed or first seen)"):this.debugLog("offline alert sent (still offline)")}async sendNotifications(t){seal.ext.getBoolConfig(this.ext,"NOTIFY_ONEBOT")&&await this.notifyByOneBotHttp(t)}async notifyByOneBotHttp(t){let e=seal.ext.getStringConfig(this.ext,"GOBOT_URL"),n=seal.ext.getStringConfig(this.ext,"GOBOT_QQ"),s=seal.ext.getStringConfig(this.ext,"GOBOT_TOKEN"),i=S(n);if(!e||!i){console.error(`[${c}] OneBot HTTP notify skipped: GOBOT_URL or GOBOT_QQ invalid`);return}let r=i.kind==="group"?"send_group_msg":"send_private_msg",l=x(e,r),u=i.kind==="group"?{group_id:Number(i.groupId),message:t}:{user_id:Number(i.userId),message:t},f={"Content-Type":"application/json"},h=(s||"").trim();h&&(f.Authorization=`Bearer ${h}`);try{let g=await fetch(l,{method:"POST",headers:f,body:JSON.stringify(u)});if(g.ok)this.debugLog("OneBot HTTP notify ok");else{let p=await g.text().catch(()=>"");console.error(`[${c}] OneBot HTTP notify failed: ${g.status} ${g.statusText} ${p}`)}}catch(g){console.error(`[${c}] OneBot HTTP notify exception:`,g)}}},a=seal.ext.find(c);a||(a=seal.ext.new(c,"clio-7","1.0.1"),seal.ext.register(a),seal.ext.registerStringConfig(a,"ONEBOT_WS_SERVER","ws://127.0.0.1:6700","OneBot WS \u6B63\u5411\u5730\u5740\uFF08\u793A\u4F8B\uFF1Aws://127.0.0.1:6700\uFF09"),seal.ext.registerStringConfig(a,"ONEBOT_WS_TOKEN","","OneBot WS access_token\uFF08\u53EF\u7559\u7A7A\uFF1B\u975E\u7A7A\u65F6\u8FFD\u52A0 ?access_token=...\uFF09"),seal.ext.registerIntConfig(a,"ONEBOT_WS_RECONNECT_SEC",10,"WS \u65AD\u5F00\u540E\u91CD\u8FDE\u95F4\u9694\uFF08\u79D2\uFF09"),seal.ext.registerIntConfig(a,"ALERT_COOLDOWN_SEC",300,"\u79BB\u7EBF\u544A\u8B66\u51B7\u5374\u65F6\u95F4\uFF08\u79D2\uFF1B0 \u8868\u793A\u6BCF\u6B21\u79BB\u7EBF heartbeat \u90FD\u901A\u77E5\uFF09"),seal.ext.registerBoolConfig(a,"DEBUG_LOG",!1,"\u8F93\u51FA\u8C03\u8BD5\u65E5\u5FD7"),seal.ext.registerBoolConfig(a,"NOTIFY_ONEBOT",!1,"\u542F\u7528 OneBot HTTP \u901A\u77E5"),seal.ext.registerStringConfig(a,"GOBOT_URL","http://127.0.0.1:5700","OneBot HTTP API \u57FA\u5730\u5740\uFF08\u793A\u4F8B\uFF1Ahttp://127.0.0.1:5700\uFF09"),seal.ext.registerStringConfig(a,"GOBOT_QQ","","\u63A8\u9001\u76EE\u6807\uFF1Auser_id=\u4E2A\u4EBAQQ \u6216 group_id=QQ\u7FA4\uFF08\u4E5F\u53EF\u76F4\u63A5\u586B\u7EAF\u6570\u5B57\uFF0C\u89C6\u4E3A user_id\uFF09"),seal.ext.registerStringConfig(a,"GOBOT_TOKEN","","OneBot HTTP access_token\uFF08\u53EF\u7559\u7A7A\uFF1B\u975E\u7A7A\u65F6\u4EE5 Authorization: Bearer \u4F20\u9012\uFF09"));var T=new d(a);a.onLoad=()=>{T.start()};a.onUnload=()=>{T.stop()};})();
